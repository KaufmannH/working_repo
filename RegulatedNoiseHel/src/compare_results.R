# This is a script for evaluating possible changes that occur when changing the pipeline

library(tidyverse)
library(Seurat)
library(patchwork)
library(scales)


source('src/FunctionLibHel.R')
source('src/FunctionLib_fast.R')

out_path <- "data/comparison/reproduced_fast"
old_data_path <- "data/processed/original_version"
new_data_path <- "data/processed/reproduced_fast" 
new_data_path



# 1. Read objects

# old spleen
old_spleen_blank <- merge_processed_seurat_objects(paste0(old_data_path, "/seurat_objects"))
old_spleen <- add_resvar_to_seurat_object(old_spleen_blank, paste0(old_data_path,"/res_var_tables"))
old_spleen
# reproduced spleen
reproduced_spleen_blank <- merge_processed_seurat_objects(paste0(new_data_path, "/seurat_objects"))
reproduced_spleen <- add_resvar_to_seurat_object(reproduced_spleen_blank, paste0(new_data_path,"/res_var_tables"))
reproduced_spleen


# 2. Comparing the original/old spleen object generated by stephan with my reproduced and updated versions

setdiff(rownames(reproduced_spleen), rownames(old_spleen)) |> head()
paste('new:', dim(reproduced_spleen), dim(reproduced_spleen@misc$resvar_table))
paste('old:', dim(old_spleen), dim(old_spleen@misc$resvar_table))


df_old <- old_spleen@misc$resvar_table 
df_new <- reproduced_spleen@misc$resvar_table


# 2.1 distribution resvar
compare_res_var_distributions(df_old, df_new, out_path)


# 2.2 correlation res_var
correlating_res_var(df_old, df_new, out_path)
correlating_res_var_log(df_old, df_new, out_path)
# heatmap
correlating_res_var_heat(df_old, df_new, out_path)
correlating_res_var_log(df_old, df_new, out_path)



# 2.3 clustering comparison
age_sex_group <- "18m_female"
umap_cluster_comparison(age_sex_group, old_data_path, new_data_path, out_path)
umap_cluster_comparison_grey(age_sex_group, old_data_path, new_data_path, out_path)


# 2.4 compare gene variability (HVG, LVG, Intermediate)

# percent overlap between tags
gene_var_group_comparison(df_old, df_new, out_path)







          # troubleshooting
          onj1 <- readRDS("data/processed/reproduced/seurat_objects/Spleen_18m_female_processed.rds")
          onj12 <- GetAssayData(object = onj1, assay = "SCT", slot = "scale.data")
          raw <- readRDS('data/rawdata/Spleen_rawdata.rds')
          so_full <- raw

            so_full[["percent.mt"]] <- PercentageFeatureSet(so_full, pattern = "^Mt")
            so_full[["age_sex"]] <- so_full@meta.data %>% mutate(age_sex = paste0(age, "_", sex)) %>% pull(age_sex)
            so_full <- subset(so_full, subset = nFeature_originalexp > min_n_genes & nCount_originalexp > min_n_counts & nCount_originalexp < max_n_counts & percent.mt < max_percent_mt)
            
            # only analyze subsets with sufficient number of cells
            AgeSexGroups <- unique(so_full@meta.data$age_sex)
            keep <- vector(mode = "logical", length = length(AgeSexGroups))

            for (i in 1:length(AgeSexGroups)) {
              keep[i] <- so_full@meta.data %>% filter(age_sex == AgeSexGroups[i]) %>% nrow() >= min_cells
            }
            AgeSexGroups <- factor(AgeSexGroups[keep])
            print(AgeSexGroups)
            age_group <- "18m_female"
              so <- subset(so_full, subset = age_sex == age_group)


          so_intermediate <- SCTransform_v2(so, assay = "originalexp", verbose = FALSE)

          # after SCT end result
          dim(onj1)
          # after SCT directly
          dim(so_intermediate)

          # before SCT
          dim(so)



              # 1.2 Run Dimensionality Reduction 
              so <- RunPCA(so_intermediate, verbose = FALSE, npcs = npc_pca)

          dim(so)
              so <- RunUMAP(so, dims = 1:dim_umap, verbose = FALSE)
          dim(so)


              so <- FindNeighbors(so, reduction = "pca", dims = 1:dim_neighbors, verbose = FALSE) %>%
                FindClusters(resolution = cluster_res, algorithm = 4, verbose = FALSE)

          dim(so)

          so_i2 <- AssignUnstableCellFlag(so)
              frac_UnstableCells <- round(sum(so$UnstableCells) / nrow(so[[]]), 3)
            
              new_row <- c(tissue = tissue, age_group = age_group, fractionUnstable = frac_UnstableCells)
              fraction_removed <- bind_rows(fraction_removed, new_row)
              
              print(paste("Fraction of unstable cells being removed:", 
                          frac_UnstableCells, 
                          sep = " "))

          dim(so_i2)


              # 2.1.2 Subset the Seurat Object excluding the unstable cells
              filter_mask <- !so_i2@meta.data$UnstableCells
              so <- subset(so_i2, subset = UnstableCells == FALSE)
              
              # vst_out is not automatically subset, so it needs to be done manually
              so@assays$SCT@misc$vst.out$cell_attr <- so@assays$SCT@misc$vst.out$cell_attr[filter_mask,]

          dim(so)

              # 4.1 detection
              print("doublet detection ...")
              doublet_results <- detect_doublets(so@assays$SCT@counts, so@meta.data$seurat_clusters)
              so <- AddMetaData(so, column_to_rownames(doublet_results$doublet_density, var = "cell"))

              doublet_clusters <- doublet_results$cluster_table %>% # fine tune this step?
                filter(num.de < num.de_cutoff) %>% 
                pull(query_cluster)
              so@meta.data$dbl_dens.score
              
          dim(so)

          # vllt merging leads to different dims? check separately
          fem_rep1 <- readRDS("data/processed/reproduced_vs1/seurat_objects/Spleen_3m_female_processed.rds")
          fem_rep2 <- readRDS("data/processed/reproduced/seurat_objects/Spleen_3m_female_processed.rds")

          dim(fem_rep1)
          dim(fem_rep2)






